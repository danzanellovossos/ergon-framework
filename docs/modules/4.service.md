## Service Module

### Overview

The Service Module defines the **external world handlers** of the Ergon Framework. A **Service** encapsulates all direct interaction with external systems, APIs, databases, or protocols.

Services are the "low-level intelligence" of the architecture. They own:
- **Networking**: HTTP, TCP, gRPC, etc.
- **Protocol Semantics**: Authentication, retries, headers, pagination, cursors.
- **Resilience**: Backoff strategies, circuit breakers, error translation.

### Standalone and Injected Usage

Unlike Connectors, **Services are standalone components**. They do not depend on the task framework's transaction loop.

- **Standalone**: A Service can be instantiated and used in isolation (e.g., in a script or tool).
- **Injected**: Services can be injected directly into Tasks to provide capabilities.
    - Example: A `TranslationTask` might use an injected `DeepLService` to translate text inside a transaction.
    - The Task calls `self.deepl_service.translate(...)`.
    - The Service handles the HTTP call, API key, retries, and rate limits.

### Relationship with Connectors

When a Service is used as the **source** or **sink** of a pipeline (i.e., driving the main loop), it is wrapped by a **Connector**.

- The Connector calls the Service to get data.
- The Service does the actual work.

But many Services (like LLM clients, Geocoding APIs, or Database lookups) are never wrapped in Connectors because they are used *ad-hoc* by the business logic, not as the primary flow driver.

### Instantiation and configuration

A service is instantiated either by a Connector (when used for flow) or by the Runner (when injected directly). It is configured via `ServiceConfig` which contains the service class and its initialization arguments.

The service owns all persistent communication state, such as open sessions, sockets, HTTP clients, message channels, stream cursors, subscription contexts, batching buffers, or token refreshers.

### Transactions and atomicity

Services are responsible for preserving the external systemâ€™s definition of atomicity. If a system emits micro-batches, a service retrieves them intact. If a system emits continuous streams, a service determines where atomic boundaries occur.

### Reliability and fault handling

All retry logic, backoff strategies, throttling, circuit-breaking behavior, error normalization, and idempotency rules are implemented at the service level. This is because different systems have different fault models. The service hides all of these concerns behind a stable interface.

### Pagination and streaming

Pagination and streaming behaviors also belong entirely to services. For APIs, services handle tokens, continuation cursors, and pagination windows. No pagination logic or streaming complexity ever leaks into tasks.

### Observability

Observability is deeply integrated into services. Services receive tracer and logger instances automatically. They annotate tracing spans with protocol details: latency, payload sizes, pagination metadata, retry counts, batch sizes, external identifiers, or error categories.

### Concurrency model

Services do not manage concurrency models. Whether they are called via synchronous code, executed in thread pools, or awaited inside asynchronous event loops, the service itself remains unaware. It simply exposes synchronous or asynchronous methods depending on its implementation.

### Scaling

Scaling is also defined externally. Services expose whatever mechanisms the external system provides for parallelism: partition keys, shard identifiers, consumer groups, cursor positions, or load-balanced endpoints.

### Summary

In conclusion, the Service Module is the protocol and transport execution engine. It encapsulates all communication mechanics and can be used in two ways:
1.  **Directly by Tasks** (via dependency injection) for enrichment and capabilities.
2.  **Wrapped by Connectors** for driving the main transaction flow.

This flexibility allows Ergon to handle both "pipeline" workloads and "rpc/api" style interactions within the same clean architecture.
